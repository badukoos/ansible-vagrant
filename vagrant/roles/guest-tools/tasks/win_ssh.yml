---
- name: Install OpenSSH Server
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = 'Stop'

      $changed = $false
      $reboot_required = $false

      $cap = Get-WindowsCapability -Online -Name 'OpenSSH.Server*' | Select-Object -First 1
      if (-not $cap) { throw "OpenSSH.Server capability not found" }

      if ($cap.State -ne 'Installed') {
        $result = Add-WindowsCapability -Online -Name $cap.Name

        $ssh = Get-WindowsCapability -Online -Name $cap.Name
        if ($ssh.State -ne 'Installed') { throw "Install failed, state=$($ssh.State)" }

        $changed = $true
        $reboot_required = [bool]$result.RestartNeeded
      }

      [pscustomobject]@{
        changed = $changed
        reboot_required = $reboot_required
        capability = $cap.Name
      } | ConvertTo-Json -Compress
  register: openssh_status
  changed_when: (openssh_status.output[0] | from_json).changed | default(false)

- name: Reboot if needed
  ansible.windows.win_reboot:
  when: (openssh_status.output[0] | from_json).reboot_required | default(false)

- name: Ensure sshd service startup mode is automatic
  ansible.windows.win_service:
    name: sshd
    start_mode: auto

- name: Ensure sshd service is running
  ansible.windows.win_service:
    name: sshd
    state: "{{ windows_openssh_service_state }}"

- name: Ensure OpenSSH firewall rule exists
  community.windows.win_firewall_rule:
    name: OpenSSH-Server-In-TCP
    localport: "{{ windows_openssh_firewall_port }}"
    protocol: tcp
    direction: in
    action: allow
    state: present
    enabled: true

- name: Set PowerShell as default SSH shell
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\OpenSSH
    name: DefaultShell
    data: "{{ windows_openssh_default_shell }}"
    type: string
